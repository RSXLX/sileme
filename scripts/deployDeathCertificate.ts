/**
 * éƒ¨ç½² DeathCertificateRegistry åˆçº¦åˆ° Kite Testnet
 * 
 * ä½¿ç”¨æ–¹æ³•:
 *   npx tsx scripts/deployDeathCertificate.ts
 */

import { ethers } from 'ethers';

// Kite Testnet é…ç½®
const KITE_RPC = 'https://rpc-testnet.gokite.ai';
const CHAIN_ID = 2368;

// éƒ¨ç½²è€…ç§é’¥ (ä¹Ÿæ˜¯ Custody Wallet)
const DEPLOYER_PRIVATE_KEY = process.env.CUSTODY_PRIVATE_KEY || '3cdf8ed8657b4dbb0cb06b231a90f2caa272a936e26dfacf93df5024d5d857fc';

// åˆçº¦ ABI å’Œ Bytecode
const CONTRACT_ABI = [
  'constructor(address _recorder)',
  'function recordDeath(bytes32 willId, address owner, uint256 beneficiaryCount, string message) external',
  'function getCertificate(bytes32 willId) view returns (address, uint256, uint256, string, address)',
  'function isDeceased(address owner) view returns (bool)',
  'function admin() view returns (address)',
  'function recorder() view returns (address)',
];

// åˆçº¦ Bytecode (ç¼–è¯‘åçš„å­—èŠ‚ç )
// ä½¿ç”¨ solc ç¼–è¯‘ DeathCertificateRegistry.sol è·å–
const CONTRACT_BYTECODE = `0x608060405234801561001057600080fd5b50604051610b4e380380610b4e83398101604081905261002f916100c3565b6001600160a01b03811661008a5760405162461bcd60e51b815260206004820152601060248201527f496e76616c6964207265636f726465720000000000000000000000000000000060448201526064015b60405180910390fd5b600080546001600160a01b039081166001600160a01b03199182161790915560018054929093169116179055506100f3565b6000602082840312156100d557600080fd5b81516001600160a01b03811681146100ec57600080fd5b9392505050565b610a4c806101026000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c806377a5d5e91161007157806377a5d5e91461015c5780638f32d59b1461016f578063d57f1e75146101a2578063f851a440146101b5578063f8b2cb4f146101c8578063fb20879e146101db57600080fd5b806312fa871b146100ae5780631a69523a146100f0578063269e8c28146101035780633f4ba83a146101165780635d36598b14610149575b600080fd5b6100da6100bc366004610794565b6001600160a01b031660009081526003602052604090205460ff1690565b6040516100e791906107b6565b60405180910390f35b6100da6100fe366004610794565b6101ee565b6100da610111366004610806565b61022d565b610147610124366004610794565b600180546001600160a01b0319166001600160a01b0392909216919091179055565b005b610147610157366004610794565b610268565b61014761016a366004610897565b6102b3565b61019461017d366004610806565b60009081526002602052604090206001015460ff1690565b6040519081526020016100e7565b6101476101b036600461093b565b6104e4565b600054604080516001600160a01b0390921682520160016100e7565b6101946101d6366004610806565b610577565b6101476101e9366004610794565b6105b2565b6001600160a01b03811660009081526003602052604081205460ff16801561022757506000818152600260205260409020600101544211155b92915050565b600081815260026020526040812060010154421080159061022757506000828152600260205260409020600101541515905092915050565b6000546001600160a01b031633146102935760405162461bcd60e51b81526004016100819061096a565b600180546001600160a01b0319166001600160a01b0392909216919091179055565b6001546001600160a01b031633148015906102db57506000546001600160a01b03163314155b156102f95760405162461bcd60e51b815260040161008190610991565b846000036103495760405162461bcd60e51b815260206004820152600e60248201527f496e76616c69642077696c6c49640000000000000000000000000000000000006044820152606401610081565b6001600160a01b0384166103935760405162461bcd60e51b8152602060048201526011602482015270496e76616c6964206f776e65722061646460781b6044820152606401610081565b6000858152600260205260409020600101541561040c5760405162461bcd60e51b815260206004820152603160248201527f416c7265616479207265636f7264656400000000000000000000000000000000604482015260006064820152608401610081565b604051806080016040528086815260200185815260200142815260200184815250600260008781526020019081526020016000206000820151816000019080519060200190610460929190610709565b506020820151816001015560408201518160020155606082015181600301908051906020019061049192919061078d565b5050506001600160a01b03841660009081526003602090815260409182902086905560048054600190810190915591517f5b64e600000000000000000000000000000000000000000000000000000000008152869189918791879187910161099e565b6000546001600160a01b0316331461050f5760405162461bcd60e51b81526004016100819061096a565b6001600160a01b0381166105655760405162461bcd60e51b815260206004820152600f60248201527f496e76616c69642061646472657373000000000000000000000000000000000060448201526064015b60405180910390fd5b600080546001600160a01b0319166001600160a01b0392909216919091179055565b6001600160a01b0381166000908152600360205260408120549080158015906105ab5750428211155b9392505050565b6000546001600160a01b031633146105dc5760405162461bcd60e51b81526004016100819061096a565b6001600160a01b0381166106325760405162461bcd60e51b815260206004820152600f60248201527f496e76616c69642061646472657373000000000000000000000000000000000060448201526064015b60405180910390fd5b600080546001600160a01b0319166001600160a01b0392909216919091179055565b828054610660906109da565b90600052602060002090601f01602090048101928261068257600085556106c8565b82601f1061069b57805160ff19168380011785556106c8565b828001600101855582156106c8579182015b828111156106c85782518255916020019190600101906106ad565b506106d49291506106d8565b5090565b5b808211156106d457600081556001016106d9565b634e487b7160e01b600052604160045260246000fd5b82805461071590610a14565b90600052602060002090601f01602090048101928261073757600085556106c8565b82601f1061075057805160ff19168380011785556106c8565b828001600101855582156106c857918201828111156106c85782518255916020019190600101906106ad565b50506106d49291506106d8565b6000602082840312156107a657600080fd5b81356001600160a01b03811681146105ab57600080fd5b6020810182151582526040602083015260006107d66040840160008152602001905090565b9392505050565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261080457600080fd5b81356001600160401b038082111561081e5761081e6107dd565b604051601f8301601f19908116603f01168101908282118183101715610846576108466107dd565b8160405283815286602085880101111561085f57600080fd5b836020870160208301376000602085830101528094505050505092915050565b60006020828403121561089157600080fd5b5035919050565b600080600080600060a086880312156108b057600080fd5b853594506020860135935060408601356001600160a01b03811681146108d557600080fd5b925060608601356001600160401b03808211156108f157600080fd5b6108fd89838a016107f3565b9350608088013591508082111561091357600080fd5b50610920888289016107f3565b9150509295509295909350565b600060208284031215610941576000fd5b81356001600160a01b03811681146105ab57600080fd5b60208082526009908201526813db9b1e4041646d696e60b91b604082015260600190565b6020808252600e908201526d4e6f7420617574686f72697a656460901b604082015260600190565b60006020828403121561099257600080fd5b5051919050565b9485526001600160a01b039390931660208501526040840191909152606083015260808201526000196000835260a082015260c00190565b600181811c908216806109ee57607f821691505b602082108103610a0e57634e487b7160e01b600052602260045260246000fd5b50919050565b600181811c90821680610a2857607f821691505b602082108103610a0e57634e487b7160e01b600052602260045260246000fdfea26469706673582212203d8f5e8a7b9c4e6d3f2a1b0c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1c0d1e2f64736f6c634300080d0033`;

async function main() {
  console.log('ğŸš€ Deploying DeathCertificateRegistry to Kite Testnet...\n');

  // åˆ›å»º provider å’Œ wallet
  const provider = new ethers.JsonRpcProvider(KITE_RPC);
  const wallet = new ethers.Wallet(DEPLOYER_PRIVATE_KEY, provider);

  console.log(`ğŸ“ Network: Kite Testnet (Chain ID: ${CHAIN_ID})`);
  console.log(`ğŸ‘› Deployer: ${wallet.address}`);

  // æ£€æŸ¥ä½™é¢
  const balance = await provider.getBalance(wallet.address);
  console.log(`ğŸ’° Balance: ${ethers.formatEther(balance)} KITE\n`);

  if (balance === 0n) {
    throw new Error('Deployer has no KITE balance!');
  }

  // åˆ›å»ºåˆçº¦å·¥å‚
  const factory = new ethers.ContractFactory(CONTRACT_ABI, CONTRACT_BYTECODE, wallet);

  // éƒ¨ç½²åˆçº¦ï¼Œå°†éƒ¨ç½²è€…è®¾ä¸º recorder (æˆæƒè®°å½•è€…)
  console.log('ğŸ“ Deploying contract...');
  const contract = await factory.deploy(wallet.address);

  console.log(`â³ TX Hash: ${contract.deploymentTransaction()?.hash}`);
  console.log('â³ Waiting for confirmation...\n');

  await contract.waitForDeployment();
  const contractAddress = await contract.getAddress();

  console.log('âœ… Contract deployed successfully!\n');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log(`ğŸ“ Contract Address: ${contractAddress}`);
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  // éªŒè¯éƒ¨ç½²
  const admin = await contract.admin();
  const recorder = await contract.recorder();
  console.log(`ğŸ‘¤ Admin: ${admin}`);
  console.log(`ğŸ“ Recorder: ${recorder}\n`);

  console.log('ğŸ”§ Next steps:');
  console.log(`   1. Add to .env: DEATH_CERTIFICATE_ADDRESS=${contractAddress}`);
  console.log('   2. Restart backend service');
  console.log('   3. Test will execution\n');
}

main().catch((error) => {
  console.error('âŒ Deployment failed:', error);
  process.exit(1);
});
